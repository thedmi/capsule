
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../20_motivation/">
      
      
        <link rel="next" href="../40_how_does_this_work/">
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.15">
    
    
      
        <title>Usage - Capsule</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.342714a4.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="deep-purple" data-md-color-accent="green">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#usage" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="Capsule" class="md-header__button md-logo" aria-label="Capsule" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m20 22-3.86-1.55c.7-1.53 1.2-3.11 1.51-4.72zM7.86 20.45 4 22l2.35-6.27c.31 1.61.81 3.19 1.51 4.72M12 2s5 2 5 10c0 3.1-.75 5.75-1.67 7.83A2 2 0 0 1 13.5 21h-3a2 2 0 0 1-1.83-1.17C7.76 17.75 7 15.1 7 12c0-8 5-10 5-10m0 10c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Capsule
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Usage
            
          </span>
        </div>
      </div>
    </div>
    
      
    
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/thedmi/capsule" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Capsule" class="md-nav__button md-logo" aria-label="Capsule" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m20 22-3.86-1.55c.7-1.53 1.2-3.11 1.51-4.72zM7.86 20.45 4 22l2.35-6.27c.31 1.61.81 3.19 1.51 4.72M12 2s5 2 5 10c0 3.1-.75 5.75-1.67 7.83A2 2 0 0 1 13.5 21h-3a2 2 0 0 1-1.83-1.17C7.76 17.75 7 15.1 7 12c0-8 5-10 5-10m0 10c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2"/></svg>

    </a>
    Capsule
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/thedmi/capsule" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Introduction
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../10_quickstart/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Quick Start
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../20_motivation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Motivation
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    Usage
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    Usage
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#installation" class="md-nav__link">
    <span class="md-ellipsis">
      Installation
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#implementing-capsules" class="md-nav__link">
    <span class="md-ellipsis">
      Implementing Capsules
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Implementing Capsules">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#interface-generation" class="md-nav__link">
    <span class="md-ellipsis">
      Interface Generation
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#exposing-methods-properties" class="md-nav__link">
    <span class="md-ellipsis">
      Exposing Methods &amp; Properties
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#synchronization" class="md-nav__link">
    <span class="md-ellipsis">
      Synchronization
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Synchronization">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#synchronization-modes" class="md-nav__link">
    <span class="md-ellipsis">
      Synchronization Modes
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#invocation-owner" class="md-nav__link">
    <span class="md-ellipsis">
      Invocation Owner
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sync-async" class="md-nav__link">
    <span class="md-ellipsis">
      Sync / Async
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#thread-safety" class="md-nav__link">
    <span class="md-ellipsis">
      Thread-Safety
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#run-to-completion-semantics" class="md-nav__link">
    <span class="md-ellipsis">
      Run to Completion Semantics
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#exception-handling" class="md-nav__link">
    <span class="md-ellipsis">
      Exception Handling
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cancellation" class="md-nav__link">
    <span class="md-ellipsis">
      Cancellation
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#disposable-capsules" class="md-nav__link">
    <span class="md-ellipsis">
      Disposable Capsules
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#opt-in-features" class="md-nav__link">
    <span class="md-ellipsis">
      Opt-In Features
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Opt-In Features">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#async-initializer" class="md-nav__link">
    <span class="md-ellipsis">
      Async Initializer
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#timers" class="md-nav__link">
    <span class="md-ellipsis">
      Timers
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#testing" class="md-nav__link">
    <span class="md-ellipsis">
      Testing
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Testing">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#test-support-library" class="md-nav__link">
    <span class="md-ellipsis">
      Test Support Library
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../40_how_does_this_work/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    How does this Work?
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../50_comparison_with_other_concepts/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Comparison with Other Concepts
    
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#installation" class="md-nav__link">
    <span class="md-ellipsis">
      Installation
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#implementing-capsules" class="md-nav__link">
    <span class="md-ellipsis">
      Implementing Capsules
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Implementing Capsules">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#interface-generation" class="md-nav__link">
    <span class="md-ellipsis">
      Interface Generation
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#exposing-methods-properties" class="md-nav__link">
    <span class="md-ellipsis">
      Exposing Methods &amp; Properties
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#synchronization" class="md-nav__link">
    <span class="md-ellipsis">
      Synchronization
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Synchronization">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#synchronization-modes" class="md-nav__link">
    <span class="md-ellipsis">
      Synchronization Modes
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#invocation-owner" class="md-nav__link">
    <span class="md-ellipsis">
      Invocation Owner
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sync-async" class="md-nav__link">
    <span class="md-ellipsis">
      Sync / Async
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#thread-safety" class="md-nav__link">
    <span class="md-ellipsis">
      Thread-Safety
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#run-to-completion-semantics" class="md-nav__link">
    <span class="md-ellipsis">
      Run to Completion Semantics
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#exception-handling" class="md-nav__link">
    <span class="md-ellipsis">
      Exception Handling
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cancellation" class="md-nav__link">
    <span class="md-ellipsis">
      Cancellation
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#disposable-capsules" class="md-nav__link">
    <span class="md-ellipsis">
      Disposable Capsules
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#opt-in-features" class="md-nav__link">
    <span class="md-ellipsis">
      Opt-In Features
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Opt-In Features">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#async-initializer" class="md-nav__link">
    <span class="md-ellipsis">
      Async Initializer
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#timers" class="md-nav__link">
    <span class="md-ellipsis">
      Timers
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#testing" class="md-nav__link">
    <span class="md-ellipsis">
      Testing
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Testing">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#test-support-library" class="md-nav__link">
    <span class="md-ellipsis">
      Test Support Library
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="usage">Usage</h1>
<h2 id="installation">Installation</h2>
<p>Capsule is shipped as a set of Nuget packages:</p>
<ul>
<li><a href="https://www.nuget.org/packages/Capsule.Core/"><img alt="Capsule.Core" src="https://img.shields.io/nuget/v/Capsule.Core?label=Capsule.Core" /></a> Core functionality such as invocation loop and synchronizer implementations. Also contains dependency injection registration extensions.</li>
<li><a href="https://www.nuget.org/packages/Capsule.Generator/"><img alt="Capsule.Generator" src="https://img.shields.io/nuget/v/Capsule.Generator?label=Capsule.Generator" /></a> C# source generator that generates interfaces and encapsulation boilerplate based on attributes.</li>
<li><a href="https://www.nuget.org/packages/Capsule.Testing/"><img alt="Capsule.Testing" src="https://img.shields.io/nuget/v/Capsule.Testing?label=Capsule.Testing" /></a> Test support library.</li>
</ul>
<p>To get started, install the <code>Capsule.Core</code> and <code>Capsule.Generator</code> packages. Then, register the necessary dependencies with the <code>AddCapsuleHost()</code> DI extension method.</p>
<h2 id="implementing-capsules">Implementing Capsules</h2>
<p>The <em>capsule implementation</em> is the class that needs to be made thread-safe. You create it, but do not add any synchronization primitives yourself.</p>
<p>By adding he <code>[Capsule]</code> attribute to that class, the Capsule generator is instructed to add the following parts:</p>
<ul>
<li>The capsule interface is generated or referenced.</li>
<li>A static extension class is generated, containing the hull and an <code>Encapsulate()</code> extension method. This is what turns your capsule implementation into a thread-safe object.</li>
</ul>
<p>The following subsections provide further details on these two parts.</p>
<h3 id="interface-generation">Interface Generation</h3>
<p>Capsule generator is able to generate a capsule interface for each capsule implementation.</p>
<p>By default, Capsule considers the list of implemented interfaces on the Capsule implementation:</p>
<ul>
<li>If there is exactly one interface that is not <code>[CapsuleIgnore]</code> attributed, that interface is used and no additional interface is generated.</li>
<li>Otherwise, an interface with the same name as the implementation, but prefixed with an "I", will be generated.</li>
</ul>
<p>Interface generation can be customized through <code>CapsuleAttribute.InterfaceGeneration</code>:</p>
<ul>
<li><code>Enable</code>: Generate an interface.</li>
<li><code>Disable</code>: Do not generate an interface.</li>
<li><code>Auto</code>: The default behavior described above applies.</li>
</ul>
<p>The interface name can be customized through <code>CapsuleAttribute.InterfaceName</code>:</p>
<ul>
<li>If this property is specified and non-null, that interface name will be used.</li>
<li>Otherwise, the default behavior applies.</li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If you bring your own interface, you'll need to ensure it matches the exposed methods and properties. Otherwise, the build will fail.</p>
</div>
<h3 id="exposing-methods-properties">Exposing Methods &amp; Properties</h3>
<p>In addition to the <code>[Capule]</code> attribute on the implementation class, you'll need to add the <code>[Expose]</code> attribute to all methods and properties that you want to make accessible through the capsule interface. The following restrictions apply:</p>
<ul>
<li>The exposed methods must have a return type that is compatible with the chosen synchronization mode (see below).</li>
<li>Properties are restricted to immutable getters and <code>PassThrough</code> synchronization mode must be used.</li>
</ul>
<p>The synchronization mode defaults to <code>AwaitCompletion</code>. Different modes can be specified through the <code>ExposeAttribute.Synchronization</code> property.</p>
<h2 id="synchronization">Synchronization</h2>
<p>Capsule can expose methods in different ways to match different use cases. The synchronization mode controls if/how invocations are awaited and whether thread-safety is guaranteed. Capsule defaults to "await completion" synchronization. This is the only mode that is thread-safe <em>and</em> makes encapsulated objects behave in an object-oriented way from the caller's perspective.</p>
<h3 id="synchronization-modes">Synchronization Modes</h3>
<p>The following synchronization modes are supported:</p>
<table>
<thead>
<tr>
<th>Synchronization Mode</th>
<th>Completes when</th>
<th>Sync / Async</th>
<th>Behavior</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>AwaitCompletion</code> (default)</td>
<td>implementation completes</td>
<td>async</td>
<td><span class="twemoji" title="caller-owned"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M304 128a80 80 0 1 0-160 0 80 80 0 1 0 160 0m-208 0a128 128 0 1 1 256 0 128 128 0 1 1-256 0M49.3 464h349.5c-8.9-63.3-63.3-112-129-112h-91.4c-65.7 0-120.1 48.7-129 112zM0 482.3C0 383.8 79.8 304 178.3 304h91.4c98.5 0 178.3 79.8 178.3 178.3 0 16.4-13.3 29.7-29.7 29.7H29.7C13.3 512 0 498.7 0 482.3"/></svg></span> <span class="twemoji" title="thread-safe"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path d="m8.533.133 5.25 1.68A1.75 1.75 0 0 1 15 3.48V7c0 1.566-.32 3.182-1.303 4.682-.983 1.498-2.585 2.813-5.032 3.855a1.7 1.7 0 0 1-1.33 0c-2.447-1.042-4.049-2.357-5.032-3.855C1.32 10.182 1 8.566 1 7V3.48a1.75 1.75 0 0 1 1.217-1.667l5.25-1.68a1.75 1.75 0 0 1 1.066 0m-.61 1.429zl-5.25 1.68a.25.25 0 0 0-.174.237V7c0 1.36.275 2.666 1.057 3.859.784 1.194 2.121 2.342 4.366 3.298a.2.2 0 0 0 .154 0c2.245-.957 3.582-2.103 4.366-3.297C13.225 9.666 13.5 8.358 13.5 7V3.48a.25.25 0 0 0-.174-.238l-5.25-1.68a.25.25 0 0 0-.153 0M11.28 6.28l-3.5 3.5a.75.75 0 0 1-1.06 0l-1.5-1.5a.749.749 0 0 1 .326-1.275.75.75 0 0 1 .734.215l.97.97 2.97-2.97a.75.75 0 0 1 1.042.018.75.75 0 0 1 .018 1.042"/></svg></span></td>
</tr>
<tr>
<td><code>AwaitEnqueueing</code></td>
<td>invocation has been enqueued</td>
<td>sync or async (details see below)</td>
<td><span class="twemoji" title="loop-owned"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M2 12a9 9 0 0 0 9 9c2.39 0 4.68-.94 6.4-2.6l-1.5-1.5A6.7 6.7 0 0 1 11 19c-6.24 0-9.36-7.54-4.95-11.95S18 5.77 18 12h-3l4 4h.1l3.9-4h-3a9 9 0 0 0-18 0"/></svg></span> <span class="twemoji" title="thread-safe"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path d="m8.533.133 5.25 1.68A1.75 1.75 0 0 1 15 3.48V7c0 1.566-.32 3.182-1.303 4.682-.983 1.498-2.585 2.813-5.032 3.855a1.7 1.7 0 0 1-1.33 0c-2.447-1.042-4.049-2.357-5.032-3.855C1.32 10.182 1 8.566 1 7V3.48a1.75 1.75 0 0 1 1.217-1.667l5.25-1.68a1.75 1.75 0 0 1 1.066 0m-.61 1.429zl-5.25 1.68a.25.25 0 0 0-.174.237V7c0 1.36.275 2.666 1.057 3.859.784 1.194 2.121 2.342 4.366 3.298a.2.2 0 0 0 .154 0c2.245-.957 3.582-2.103 4.366-3.297C13.225 9.666 13.5 8.358 13.5 7V3.48a.25.25 0 0 0-.174-.238l-5.25-1.68a.25.25 0 0 0-.153 0M11.28 6.28l-3.5 3.5a.75.75 0 0 1-1.06 0l-1.5-1.5a.749.749 0 0 1 .326-1.275.75.75 0 0 1 .734.215l.97.97 2.97-2.97a.75.75 0 0 1 1.042.018.75.75 0 0 1 .018 1.042"/></svg></span></td>
</tr>
<tr>
<td><code>AwaitReception</code></td>
<td>invocation has been dequeued</td>
<td>async</td>
<td><span class="twemoji" title="loop-owned"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M2 12a9 9 0 0 0 9 9c2.39 0 4.68-.94 6.4-2.6l-1.5-1.5A6.7 6.7 0 0 1 11 19c-6.24 0-9.36-7.54-4.95-11.95S18 5.77 18 12h-3l4 4h.1l3.9-4h-3a9 9 0 0 0-18 0"/></svg></span> <span class="twemoji" title="thread-safe"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path d="m8.533.133 5.25 1.68A1.75 1.75 0 0 1 15 3.48V7c0 1.566-.32 3.182-1.303 4.682-.983 1.498-2.585 2.813-5.032 3.855a1.7 1.7 0 0 1-1.33 0c-2.447-1.042-4.049-2.357-5.032-3.855C1.32 10.182 1 8.566 1 7V3.48a1.75 1.75 0 0 1 1.217-1.667l5.25-1.68a1.75 1.75 0 0 1 1.066 0m-.61 1.429zl-5.25 1.68a.25.25 0 0 0-.174.237V7c0 1.36.275 2.666 1.057 3.859.784 1.194 2.121 2.342 4.366 3.298a.2.2 0 0 0 .154 0c2.245-.957 3.582-2.103 4.366-3.297C13.225 9.666 13.5 8.358 13.5 7V3.48a.25.25 0 0 0-.174-.238l-5.25-1.68a.25.25 0 0 0-.153 0M11.28 6.28l-3.5 3.5a.75.75 0 0 1-1.06 0l-1.5-1.5a.749.749 0 0 1 .326-1.275.75.75 0 0 1 .734.215l.97.97 2.97-2.97a.75.75 0 0 1 1.042.018.75.75 0 0 1 .018 1.042"/></svg></span></td>
</tr>
<tr>
<td><code>PassThrough</code></td>
<td>implementation completes</td>
<td>sync or async</td>
<td><span class="twemoji" title="caller-owned"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M304 128a80 80 0 1 0-160 0 80 80 0 1 0 160 0m-208 0a128 128 0 1 1 256 0 128 128 0 1 1-256 0M49.3 464h349.5c-8.9-63.3-63.3-112-129-112h-91.4c-65.7 0-120.1 48.7-129 112zM0 482.3C0 383.8 79.8 304 178.3 304h91.4c98.5 0 178.3 79.8 178.3 178.3 0 16.4-13.3 29.7-29.7 29.7H29.7C13.3 512 0 498.7 0 482.3"/></svg></span> <span class="twemoji" title="not thread-safe"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path d="M8.533.133a1.75 1.75 0 0 0-1.066 0l-2.091.67a.75.75 0 0 0 .457 1.428l2.09-.67a.25.25 0 0 1 .153 0l5.25 1.68a.25.25 0 0 1 .174.239V7q0 .35-.025.694a.75.75 0 1 0 1.495.112Q15 7.401 15 7V3.48a1.75 1.75 0 0 0-1.217-1.667zM1 2.857l-.69-.5a.75.75 0 1 1 .88-1.214l14.5 10.5a.75.75 0 1 1-.88 1.214l-1.282-.928c-.995 1.397-2.553 2.624-4.864 3.608-.425.181-.905.18-1.329 0-2.447-1.042-4.049-2.356-5.032-3.855S1 8.566 1 7Zm1.5 1.086V7c0 1.358.275 2.666 1.057 3.86.784 1.194 2.121 2.34 4.366 3.297.05.02.106.02.153 0 2.127-.905 3.439-1.982 4.237-3.108Z"/></svg></span></td>
</tr>
<tr>
<td><code>AwaitCompletionOrPassThroughIfQueueClosed</code></td>
<td>implementation completes</td>
<td>async</td>
<td><span class="twemoji" title="caller-owned"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M304 128a80 80 0 1 0-160 0 80 80 0 1 0 160 0m-208 0a128 128 0 1 1 256 0 128 128 0 1 1-256 0M49.3 464h349.5c-8.9-63.3-63.3-112-129-112h-91.4c-65.7 0-120.1 48.7-129 112zM0 482.3C0 383.8 79.8 304 178.3 304h91.4c98.5 0 178.3 79.8 178.3 178.3 0 16.4-13.3 29.7-29.7 29.7H29.7C13.3 512 0 498.7 0 482.3"/></svg></span> <span class="twemoji" title="not thread-safe"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path d="M8.533.133a1.75 1.75 0 0 0-1.066 0l-2.091.67a.75.75 0 0 0 .457 1.428l2.09-.67a.25.25 0 0 1 .153 0l5.25 1.68a.25.25 0 0 1 .174.239V7q0 .35-.025.694a.75.75 0 1 0 1.495.112Q15 7.401 15 7V3.48a1.75 1.75 0 0 0-1.217-1.667zM1 2.857l-.69-.5a.75.75 0 1 1 .88-1.214l14.5 10.5a.75.75 0 1 1-.88 1.214l-1.282-.928c-.995 1.397-2.553 2.624-4.864 3.608-.425.181-.905.18-1.329 0-2.447-1.042-4.049-2.356-5.032-3.855S1 8.566 1 7Zm1.5 1.086V7c0 1.358.275 2.666 1.057 3.86.784 1.194 2.121 2.34 4.366 3.297.05.02.106.02.153 0 2.127-.905 3.439-1.982 4.237-3.108Z"/></svg></span></td>
</tr>
</tbody>
</table>
<h3 id="invocation-owner">Invocation Owner</h3>
<p>Invocations are either caller-owned <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M304 128a80 80 0 1 0-160 0 80 80 0 1 0 160 0m-208 0a128 128 0 1 1 256 0 128 128 0 1 1-256 0M49.3 464h349.5c-8.9-63.3-63.3-112-129-112h-91.4c-65.7 0-120.1 48.7-129 112zM0 482.3C0 383.8 79.8 304 178.3 304h91.4c98.5 0 178.3 79.8 178.3 178.3 0 16.4-13.3 29.7-29.7 29.7H29.7C13.3 512 0 498.7 0 482.3"/></svg></span> or loop-owned <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M2 12a9 9 0 0 0 9 9c2.39 0 4.68-.94 6.4-2.6l-1.5-1.5A6.7 6.7 0 0 1 11 19c-6.24 0-9.36-7.54-4.95-11.95S18 5.77 18 12h-3l4 4h.1l3.9-4h-3a9 9 0 0 0-18 0"/></svg></span>. Caller-owned invocations behave the same way as you'd expect any invocation on an object would behave: Results and exceptions are passed back to the caller.</p>
<p>Loop-owned invocations enable a "fire and forget" communication between objects. The caller can continue before the invocation has been executed, but as a result won't receive return values or exceptions. <code>AwaitEnqueueing</code> is the recommended synchronization mode for "fire and forget" style communication.</p>
<h3 id="sync-async">Sync / Async</h3>
<p>Caller-owned invocations must be async. This is due to the fact that the caller will need to be suspended until the invocation can be dequeued/executed.</p>
<p>A special case regarding sync/async is <code>AwaitEnqueueing</code> synchronization mode. This mode only needs to enqueue the invocation, which is a synchronous operation. Thus, such methods will be exposed as synchronous on the interface, unless the interface was resolved from the list of implemented interfaces on the Capsule (see <a href="#interface-generation">interface generation</a> for details).</p>
<h3 id="thread-safety">Thread-Safety</h3>
<p><code>AwaitCompletion</code>, <code>AwaitEnqueueing</code> and <code>AwaitReception</code> modes provide thread safety <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path d="m8.533.133 5.25 1.68A1.75 1.75 0 0 1 15 3.48V7c0 1.566-.32 3.182-1.303 4.682-.983 1.498-2.585 2.813-5.032 3.855a1.7 1.7 0 0 1-1.33 0c-2.447-1.042-4.049-2.357-5.032-3.855C1.32 10.182 1 8.566 1 7V3.48a1.75 1.75 0 0 1 1.217-1.667l5.25-1.68a1.75 1.75 0 0 1 1.066 0m-.61 1.429zl-5.25 1.68a.25.25 0 0 0-.174.237V7c0 1.36.275 2.666 1.057 3.859.784 1.194 2.121 2.342 4.366 3.298a.2.2 0 0 0 .154 0c2.245-.957 3.582-2.103 4.366-3.297C13.225 9.666 13.5 8.358 13.5 7V3.48a.25.25 0 0 0-.174-.238l-5.25-1.68a.25.25 0 0 0-.153 0M11.28 6.28l-3.5 3.5a.75.75 0 0 1-1.06 0l-1.5-1.5a.749.749 0 0 1 .326-1.275.75.75 0 0 1 .734.215l.97.97 2.97-2.97a.75.75 0 0 1 1.042.018.75.75 0 0 1 .018 1.042"/></svg></span>, <code>PassThrough</code> does not <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path d="M8.533.133a1.75 1.75 0 0 0-1.066 0l-2.091.67a.75.75 0 0 0 .457 1.428l2.09-.67a.25.25 0 0 1 .153 0l5.25 1.68a.25.25 0 0 1 .174.239V7q0 .35-.025.694a.75.75 0 1 0 1.495.112Q15 7.401 15 7V3.48a1.75 1.75 0 0 0-1.217-1.667zM1 2.857l-.69-.5a.75.75 0 1 1 .88-1.214l14.5 10.5a.75.75 0 1 1-.88 1.214l-1.282-.928c-.995 1.397-2.553 2.624-4.864 3.608-.425.181-.905.18-1.329 0-2.447-1.042-4.049-2.356-5.032-3.855S1 8.566 1 7Zm1.5 1.086V7c0 1.358.275 2.666 1.057 3.86.784 1.194 2.121 2.34 4.366 3.297.05.02.106.02.153 0 2.127-.905 3.439-1.982 4.237-3.108Z"/></svg></span>.</p>
<p><code>PassThrough</code> is not thread-safe because it doesn't enqueue the invocation, but executes it directly. It is <em>only</em> safe for immutable operations and is typically used with get-only properties that return an immutable field of the capsule implementation (e.g. an ID).</p>
<p><code>AwaitCompletionOrPassThroughIfQueueClosed</code> is a special case synchronization mode that behaves as <code>AwaitCompletion</code>, but falls back to <code>PassThrough</code> if the invocation queue has been closed. This is useful for <code>DisposeAsync()</code> operations, where <code>DisposeAsync()</code> may be called by DI infrastructure just before shutdown. At that point, the invocation queue has already been terminated and <code>AwaitCompletion</code> would throw a <code>CapsuleInvocationException</code>. When it falls back to <code>PassThrough</code>, thread-safety is not guaranteed.</p>
<h3 id="run-to-completion-semantics">Run to Completion Semantics</h3>
<p>All synchronization modes except <code>PassThrough</code> will execute one invocation at a time (aka <a href="https://en.wikipedia.org/wiki/Run_to_completion_scheduling">run-to-completion scheduling</a>). Make sure that your implementation completes quickly, as a blocked or delayed implementation will delay all pending invocations. This means that it is generally not a good idea to use <code>Task.Delay()</code> in capsule implementations (use a <a href="#timers">timer</a> instead).</p>
<h3 id="exception-handling">Exception Handling</h3>
<p>Exceptions that throw out of capsule implementations are routed the same way as return values are, so caller-owned invocations will throw exceptions back to the caller.</p>
<p>Loop-owned synchronization modes throw exceptions back into the invocation loop, because there is no caller that waits for the invocation to complete. In a default Capsule setup, such exceptions will abort the invocation loop and consequently the hosted service that runs it. This in turn will terminate the application.</p>
<p>This behavior is consistent with how .NET background services treat uncaught exceptions in .NET 6 and newer. The rationale for this is that uncaught exceptions must not go unnoticed. Consequently, you'll need to ensure that <em>expected</em> exceptions are caught and handled in capsule implementations.</p>
<p>Optionally, the failure mode can be changed to <code>Continue</code> through <code>CapsuleOptions.FailureMode</code>. With this failure mode, uncaught loop-owned exceptions will be logged and then ignored.</p>
<h3 id="cancellation">Cancellation</h3>
<p>Capsule treats cancellation tokens on exposed methods as any other parameter, so the tokens flow through to the capsule implementation unmodified and cancellation can be realized in the capsule implementation.</p>
<p>In case the cancellation leads to an <code>OperationCanceledException</code> being thrown out of the capsule implementation, the same behavior as outlined in <a href="#exception-handling">excpetion handling</a> applies, so you'll probably want to catch these exceptions.</p>
<p>In any case, cancellation does not remove the invocation from the queue or otherwise change synchronization behavior.</p>
<h3 id="disposable-capsules">Disposable Capsules</h3>
<p>In case your capsule implementation manages disposable resources, you may need to make the capsule disposable, too. Depending on your usage patterns, there are two possibilities to achieve this:</p>
<p>The recommended approach is to implement <code>IAsyncDisposable</code>. Like this, you'll be able to treat the dispose operation the same way as other methods. The <code>DisposeAsync()</code> method can be exposed with <code>[Expose]</code>, invocations will then flow through the invocation queue as expected. In case the capsules are registered with DI, you may want to use <code>AwaitCompletionOrPassThroughIfQueueClosed</code> synchronization mode to avoid exceptions on app shutdown (see <a href="#synchronization-modes">synchronization modes</a> for details).</p>
<p>Another possibility is to implement <code>IDisposable</code> and expose the <code>Dispose()</code> method with synchronization mode <code>PassThrough</code>. With this approach, <code>Dispose()</code> will be called synchronously, thread-safety is not guaranteed. However, for cases where <code>Dispose()</code> is only called by DI on app shutdown, this may be a suitable solution for you, because Capsule hosting will have terminated and processed all invocation queues by the time DI calls <code>Dispose()</code>.</p>
<h2 id="opt-in-features">Opt-In Features</h2>
<h3 id="async-initializer">Async Initializer</h3>
<p>Capsule implementations that need to perform asynchronous initialization can implement the <code>CapsuleFeature.IInitializer</code> interface, which defines a <code>Task InitializeAsync()</code> method.</p>
<p>Capsule will enqueue a single call to this method when a capsule is instantiated through <code>Encapsulate()</code>, so the invocation is guaranteed to be the first one to end up in the invocation queue and will run as soon as the invocation loop is started.</p>
<h3 id="timers">Timers</h3>
<p>Run-to-completion semantics dictate that individual runs should complete quickly. In other words, awaiting large delays or even sleeping is discouraged and will break responsiveness of the capsule, potentially leading to invocation queue exhaustion.</p>
<p>To work around this limitation, Capsule provides a timer service. The service can be used by making capsules implement <code>CapsuleFeature.ITimers</code>. When implemented, Capsule will inject an <code>ITimerService</code> during encapsulation.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The timer service will not be available when the constructor of the capsule implementation runs as this would create a chicken-and-egg problem. If you need to start timers when the capsule is instantiated, use an <a href="#async-initializer">async initializer</a>.</p>
</div>
<p>You can then use the timer service to register callbacks with a timeout through <code>StartSingleShot()</code>. When the timeout expires, the callback will be enqueued as just another invocation. Timers thus adheres to the thread-safety guarantees of the capsule.</p>
<p>Pending timers can also be cancelled. Either cancel a single timer through its <code>TimerReference</code>, or cancel all timers through <code>ITimerService.CancelAll()</code>.</p>
<p>For cases where only a single timer is needed, but that timer may be restarted multiple times, consider passing a <code>discriminator</code> to <code>StartSingleShot()</code>. The timer service will then ensure that at most one timer with the same discriminator exists, previous ones will be cancelled.</p>
<h2 id="testing">Testing</h2>
<p>One of the advantages of Capsule is that implementations remain free of synchronization code like locks or similar. Consequently, implementations can simply be unit tested by omitting the encapsulation in tests.</p>
<p>Generally, the following approaches work best:</p>
<ul>
<li>Use the unencapsulated implementation in unit tests.</li>
<li>Use the whole Capsule in integration tests (integration as in "tests the combination of several classes together").</li>
</ul>
<h3 id="test-support-library">Test Support Library</h3>
<p>A test support library called <a href="https://www.nuget.org/packages/Capsule.Testing/"><img alt="Capsule.Testing" src="https://img.shields.io/nuget/v/Capsule.Testing?label=Capsule.Testing" /></a> is available. It provides fake implementations of Capsule infrastructure that simplifies certain test scenarios:</p>
<ul>
<li><code>FakeTimerService</code>: An <code>ITimerService</code> that can be injected into capsules that use <a href="#timers">Timers</a>. Timer firing can be controlled from test code to avoid delays in tests.</li>
<li><code>FakeSynchronizer</code>: An <code>ICapsuleSynchronizer</code> that just executes invocations directly.</li>
</ul>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "..", "features": ["navigation.instant"], "search": "../assets/javascripts/workers/search.d50fe291.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../assets/javascripts/bundle.56ea9cef.min.js"></script>
      
    
  </body>
</html>